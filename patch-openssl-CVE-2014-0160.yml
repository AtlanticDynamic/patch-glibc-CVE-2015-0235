---
 - hosts: all
   vars:
     openssl_packages: ["openssl","libssl1.0.0"]
     openssl_impacted_service:
        - nginx
        - apache2
        - postgresql
        - php5-fpm
        - openvpn
   tasks:
     - name: ensure openssl is the last version
       apt: pkg={{item}} state=latest update_cache=yes
       register: openssl_updated
       with_items: openssl_packages
       when: ansible_os_family == "Debian"

     - name: test running services  
       command: "service {{item}} status | grep -i running"
       register: services_status
       with_items: openssl_impacted_service
       when: openssl_updated | changed
       ignore_errors: true
       always_run: yes

     - name: restart running service
       service: name={{item.item}} state=restarted
       with_items: services_status.results
       when: openssl_updated.changed and item.rc == 0

